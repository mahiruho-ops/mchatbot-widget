<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸŽ¤ Voice Chat Test</h1>
        <p>This page tests the voice chat functionality of the mChatBot widget.</p>

        <div class="test-section">
            <h3>1. Widget Initialization</h3>
            <button class="test-button" onclick="initWidget()">Initialize Widget</button>
            <button class="test-button" onclick="destroyWidget()">Destroy Widget</button>
            <div id="init-status" class="status" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. Mode Switching</h3>
            <button class="test-button" onclick="switchToVoice()">Switch to Voice Chat</button>
            <button class="test-button" onclick="switchToText()">Switch to Text Chat</button>
            <div id="mode-status" class="status" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. Voice Recording Test</h3>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Switch to Voice Chat mode</li>
                <li>Click and hold the microphone button</li>
                <li>Wait for the 3-second countdown</li>
                <li>Speak for up to 30 seconds</li>
                <li>Release the button to stop recording</li>
            </ol>
            <div id="recording-status" class="status" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Console Log</h3>
            <div id="console-log" class="log"></div>
        </div>
    </div>

    <script type="module">
        let widget = null;

        // Override console.log to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'log') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog(args.join(' '), 'warn');
        };

        // Test functions
        window.initWidget = function() {
            try {
                // Create the widget
                widget = document.createElement('mchatbot-widget');
                widget.setAttribute('email', 'test@example.com');
                widget.setAttribute('name', 'Test User');
                widget.setAttribute('theme-color', '#701FAB');
                widget.setAttribute('height', '70%');
                widget.setAttribute('position', 'bottom-right');
                
                document.body.appendChild(widget);
                
                showStatus('init-status', 'Widget initialized successfully!', 'success');
                addLog('Widget element created and added to DOM');
                
                // Wait for widget to be ready
                setTimeout(() => {
                    if (widget.shadowRoot) {
                        addLog('Widget shadow root is ready');
                        showStatus('init-status', 'Widget is fully loaded and ready!', 'success');
                    } else {
                        showStatus('init-status', 'Widget shadow root not ready yet', 'info');
                    }
                }, 1000);
                
            } catch (error) {
                showStatus('init-status', `Error initializing widget: ${error.message}`, 'error');
                addLog(`Error: ${error.message}`, 'error');
            }
        };

        window.destroyWidget = function() {
            if (widget) {
                document.body.removeChild(widget);
                widget = null;
                showStatus('init-status', 'Widget destroyed', 'info');
                addLog('Widget removed from DOM');
            }
        };

        window.switchToVoice = function() {
            if (!widget || !widget.shadowRoot) {
                showStatus('mode-status', 'Widget not initialized', 'error');
                return;
            }

            try {
                // Find and click the toggle button
                const toggleBtn = widget.shadowRoot.querySelector('.toggle-chat-mode-btn');
                if (toggleBtn) {
                    toggleBtn.click();
                    showStatus('mode-status', 'Switched to Voice Chat mode', 'success');
                    addLog('Switched to Voice Chat mode');
                } else {
                    showStatus('mode-status', 'Toggle button not found', 'error');
                }
            } catch (error) {
                showStatus('mode-status', `Error switching modes: ${error.message}`, 'error');
                addLog(`Error switching modes: ${error.message}`, 'error');
            }
        };

        window.switchToText = function() {
            if (!widget || !widget.shadowRoot) {
                showStatus('mode-status', 'Widget not initialized', 'error');
                return;
            }

            try {
                // Find and click the toggle button
                const toggleBtn = widget.shadowRoot.querySelector('.toggle-chat-mode-btn');
                if (toggleBtn) {
                    toggleBtn.click();
                    showStatus('mode-status', 'Switched to Text Chat mode', 'success');
                    addLog('Switched to Text Chat mode');
                } else {
                    showStatus('mode-status', 'Toggle button not found', 'error');
                }
            } catch (error) {
                showStatus('mode-status', `Error switching modes: ${error.message}`, 'error');
                addLog(`Error switching modes: ${error.message}`, 'error');
            }
        };

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
        }

        // Auto-initialize widget after page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addLog('Page loaded, ready to test voice chat functionality');
                addLog('Click "Initialize Widget" to start testing');
            }, 500);
        });

        // Listen for voice recording events
        document.addEventListener('DOMContentLoaded', () => {
            // Monitor for voice recording events
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE && 
                                node.tagName === 'MCHATBOT-WIDGET') {
                                addLog('Widget element detected in DOM');
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>
